# Implementation Plan: User Authentication & Authorization System

**Branch**: `001-user-auth` | **Date**: 2025-11-12 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-user-auth/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the execution workflow.

## Summary

This plan implements a comprehensive user authentication and authorization system for True Champion using Supabase Auth as the authentication provider. The system will enable users to register, log in with email/password, use social OAuth (Google), and magic links for passwordless authentication. The implementation follows Next.js 15 with React Server Components using the @supabase/ssr pattern for optimal server-side rendering support. All league data will be user-scoped, ensuring complete data isolation between users. The system includes proper middleware for session management, route protection, and follows Supabase's recommended patterns for handling authentication state in both Server and Client Components.

## Technical Context

**Language/Version**: TypeScript 5+ with Next.js 16.0.1 (App Router with React Server Components)
**Primary Dependencies**:
- `@supabase/supabase-js` (v2+) - Main Supabase client library
- `@supabase/ssr` - Server-side rendering auth helpers for Next.js
- `@upstash/redis` (v1.35.6) - Existing Redis for session caching
- `zod` (v4.1.12) - Schema validation for auth forms
- `next` (v16.0.1) - Framework with App Router and RSC support

**Storage**:
- Supabase PostgreSQL (hosted) - User accounts, auth methods, sessions, verification tokens, auth logs, user-league associations
- Upstash Redis (existing) - Session caching layer for performance optimization
- User data isolation enforced via Supabase Row Level Security (RLS) policies

**Testing**: Jest with React Testing Library (to be configured), Supabase local development environment for integration tests

**Target Platform**: Web application (desktop and mobile browsers), deployed on Vercel with server-side rendering

**Project Type**: Web application (Next.js 15 App Router with hybrid rendering)

**Performance Goals**:
- Login < 2s (p95), Account creation < 3s (p95), Session validation < 100ms, Authorization checks < 50ms
- League selector switching < 1s with proper data scoping

**Constraints**:
- HTTPS required in production
- Session persistence: 7 days default
- Rate limiting: 5 failed login attempts per 15 minutes per IP
- Email verification required before full access
- All queries must be user-scoped (SEC-003)

**Scale/Scope**:
- Initial: 100-1000 users
- Growth target: Support for 10,000+ concurrent users
- Multi-league per user (up to 10 leagues per account)
- 8-12 new pages/components, 15-20 API routes, 6-8 database tables/views

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with True Champion Constitution (v1.0.0):

- **Data Security & Privacy**: ✅ YES - This feature handles user credentials and private league data
  - [x] User data scoped by user_id and league_id (Supabase RLS policies enforce this)
  - [x] Credentials encrypted at rest (Supabase Auth handles password hashing with bcrypt, OAuth tokens encrypted)
  - [x] No cross-user data access without explicit authorization (RLS policies + middleware checks)
  - [x] Security audit logging for sensitive operations (auth_logs table tracks all authentication events)

- **Platform Reliability**: ⚠️ PARTIAL - Auth depends on Supabase Auth API (external)
  - [x] Rate limiting implemented (Supabase Auth has built-in rate limits + custom IP-based rate limiting for login attempts)
  - [x] Graceful degradation with cached data fallback (Session data cached in Redis, fallback to Supabase if Redis unavailable)
  - [x] Exponential backoff retry logic (Supabase SDK handles retries, we add additional layer for Redis operations)
  - [x] Circuit breaker for consistent failures (Not required for authentication - fail fast is acceptable. Cached sessions provide continuity.)
  - [N/A] User-facing staleness indicators (Not applicable for auth - sessions are either valid or invalid)
  - **Justification**: Circuit breaker omitted because authentication should fail fast when Supabase Auth is unavailable. Users understand when login systems are down. Cached sessions provide continuity for already-authenticated users.

- **Multi-Tenant Architecture**: ✅ YES - This feature creates the multi-tenant foundation
  - [x] All database tables include user_id scoping (New tables: user_leagues, auth_logs use Supabase auth.users.id)
  - [x] All queries filter by authenticated user_id (Enforced via Supabase RLS + server-side middleware)
  - [x] Redis keys follow pattern: {user_id}:{league_id}:{resource}:{id} (Session cache updated to: session:{user_id}, leagues:{user_id})
  - [x] Services are stateless (no in-memory session state) (All session state in Supabase + Redis)
  - [x] Per-user rate limits to prevent resource monopolization (Login attempts limited per IP + per email)

- **Testing Standards**: ✅ Testing plan defined
  - [x] Contract tests for platform API response schemas (Supabase Auth response schemas tested)
  - [x] Integration tests for full data flow (Signup → Verification → Login → Session → Protected Route)
  - [N/A] Algorithm unit tests with known scenarios (No complex algorithms in authentication)
  - [x] Multi-tenant isolation tests (Test User A cannot access User B's leagues via any endpoint)
  - [x] Performance tests for requirements validation (Login < 2s, Session validation < 100ms tests)

- **Simplicity in Complexity**: ✅ YES - Clean separation of concerns
  - [x] Each service has single, clear responsibility (AuthService: auth operations, SupabaseClient: API communication, Middleware: session management)
  - [N/A] Platform-specific logic isolated in adapters (Supabase is the only auth platform)
  - [x] No premature optimization (Start with Supabase SDK defaults, add Redis caching only where proven beneficial)
  - [x] Clear layer separation (Pages → Server Actions → Services → Supabase Client)
  - [x] Configuration-driven platform differences (Environment variables for Supabase URL, keys, redirect URLs)

- **Incremental Delivery**: ✅ YES - Backward compatible approach
  - [x] Existing ESPN functionality continues working (Authentication added as new layer, existing pages remain functional)
  - [x] New platform support behind feature flags (Auth can be toggled via environment variable during rollout)
  - [x] Phased migration plan documented (Phase 1: Auth system, Phase 2: Migrate existing data to user-scoped model)
  - [x] Database migrations are idempotent and reversible (Supabase migrations with down scripts, user_leagues table additive)
  - [x] No breaking API changes (New auth endpoints added, existing ESPN data endpoints enhanced with user scoping)

- **Performance Requirements**: ✅ YES - Meets all performance standards
  - [x] Dashboard < 2s (p95), Team detail < 1s (p95), Weekly analysis < 1.5s (p95) (Auth middleware adds < 50ms overhead)
  - [x] Loading states appear < 100ms (Optimistic UI for auth state changes)
  - [x] Appropriate caching with documented TTLs (Sessions cached in Redis: 7 day TTL matching session expiry)
  - [x] Database queries use proper indexes (Supabase auth.users indexed by id/email, user_leagues indexed by user_id and league_id)
  - [x] Scales to 1,000 concurrent users (Supabase Auth scales to 100k+ users, Redis handles high read throughput)

**Constitution Compliance Summary**: ✅ **APPROVED** - All principles satisfied with documented justifications for variations.

## Project Structure

### Documentation (this feature)

```text
specs/001-user-auth/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output - Supabase Auth patterns, @supabase/ssr integration
├── data-model.md        # Phase 1 output - User, UserLeague, AuthLog entities
├── quickstart.md        # Phase 1 output - Developer setup guide
├── contracts/           # Phase 1 output - API endpoint specifications
│   ├── auth-api.yaml    # Authentication endpoints (signup, login, logout, etc.)
│   └── user-api.yaml    # User management endpoints (profile, leagues, etc.)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── app/                           # Next.js 15 App Router pages
│   ├── (auth)/                   # Auth route group (unauthenticated layout)
│   │   ├── login/
│   │   │   └── page.tsx         # Login page with email/password and OAuth
│   │   ├── signup/
│   │   │   └── page.tsx         # Signup page with email/password
│   │   ├── forgot-password/
│   │   │   └── page.tsx         # Password reset request page
│   │   ├── reset-password/
│   │   │   └── page.tsx         # Password reset confirmation page
│   │   ├── verify-email/
│   │   │   └── page.tsx         # Email verification page
│   │   └── layout.tsx           # Auth layout (no navbar, centered forms)
│   ├── (authenticated)/          # Protected route group (requires auth)
│   │   ├── dashboard/
│   │   │   └── page.tsx         # Main dashboard (renamed from root)
│   │   ├── leagues/
│   │   │   └── page.tsx         # User's league list
│   │   ├── team/[teamId]/
│   │   │   └── page.tsx         # Team details (user-scoped)
│   │   ├── week/[week]/
│   │   │   └── page.tsx         # Weekly analysis (user-scoped)
│   │   ├── settings/
│   │   │   └── page.tsx         # User account settings
│   │   └── layout.tsx           # Authenticated layout (with navbar, league selector)
│   ├── auth/
│   │   └── callback/
│   │       └── route.ts         # OAuth callback handler
│   ├── api/
│   │   ├── auth/                # Authentication API routes
│   │   │   ├── signup/
│   │   │   │   └── route.ts    # POST /api/auth/signup
│   │   │   ├── login/
│   │   │   │   └── route.ts    # POST /api/auth/login
│   │   │   ├── logout/
│   │   │   │   └── route.ts    # POST /api/auth/logout
│   │   │   ├── forgot-password/
│   │   │   │   └── route.ts    # POST /api/auth/forgot-password
│   │   │   ├── reset-password/
│   │   │   │   └── route.ts    # POST /api/auth/reset-password
│   │   │   ├── resend-verification/
│   │   │   │   └── route.ts    # POST /api/auth/resend-verification
│   │   │   └── session/
│   │   │       └── route.ts    # GET /api/auth/session
│   │   ├── user/                # User management routes
│   │   │   ├── profile/
│   │   │   │   └── route.ts    # GET/PATCH /api/user/profile
│   │   │   └── leagues/
│   │   │       └── route.ts    # GET/POST/DELETE /api/user/leagues
│   │   ├── fetch-data/          # Existing ESPN routes (now user-scoped)
│   │   ├── standings/           # Existing routes (now user-scoped)
│   │   └── weekly-scores/       # Existing routes (now user-scoped)
│   ├── middleware.ts            # Session refresh and route protection
│   └── layout.tsx               # Root layout
├── components/
│   ├── auth/                    # Authentication UI components
│   │   ├── LoginForm.tsx
│   │   ├── SignupForm.tsx
│   │   ├── ForgotPasswordForm.tsx
│   │   ├── ResetPasswordForm.tsx
│   │   ├── OAuthButtons.tsx
│   │   └── MagicLinkForm.tsx
│   ├── user/                    # User-related components
│   │   ├── LeagueSelector.tsx  # Dropdown to switch leagues
│   │   ├── UserNav.tsx         # User menu in navbar
│   │   └── ProfileSettings.tsx
│   ├── ui/                      # Existing shadcn/ui components
│   └── shared/                  # Shared components
├── lib/
│   ├── supabase/                # Supabase client utilities
│   │   ├── client.ts           # Browser client (createBrowserClient)
│   │   ├── server.ts           # Server client (createServerClient for RSC)
│   │   ├── middleware.ts       # Middleware client (session refresh)
│   │   └── types.ts            # Supabase TypeScript types
│   ├── auth/                    # Auth helper functions
│   │   ├── session.ts          # Session management helpers
│   │   ├── rate-limit.ts       # Rate limiting logic
│   │   └── validation.ts       # Auth input validation with Zod
│   ├── redis.ts                 # Existing Redis client (enhanced for sessions)
│   ├── utils.ts                 # Existing utilities
│   └── env.ts                   # Environment variable validation
├── services/
│   ├── auth-service.ts          # Authentication business logic
│   ├── user-service.ts          # User management business logic
│   ├── espn-api.ts              # Existing (enhanced with user scoping)
│   ├── true-champion.ts         # Existing algorithm
│   └── data-updater.ts          # Existing data refresh
├── types/
│   ├── auth.ts                  # Auth-related types
│   ├── user.ts                  # User entity types
│   ├── database.ts              # Database table types (generated by Supabase)
│   ├── espn.ts                  # Existing ESPN types
│   └── index.ts                 # Type exports
└── hooks/
    ├── useAuth.ts               # Auth state management hook
    ├── useUser.ts               # User data hook
    └── useSession.ts            # Session management hook

supabase/
├── migrations/                  # Database migration files
│   ├── 20251112_create_user_leagues.sql
│   ├── 20251112_create_auth_logs.sql
│   └── 20251112_setup_rls_policies.sql
├── seed.sql                     # Test data seeding
└── config.toml                  # Supabase local config

tests/
├── integration/
│   ├── auth.test.ts            # Full auth flow tests
│   ├── user-isolation.test.ts  # Multi-tenant isolation tests
│   └── session.test.ts         # Session management tests
├── unit/
│   ├── auth-service.test.ts
│   ├── user-service.test.ts
│   └── rate-limit.test.ts
└── e2e/
    ├── signup-flow.spec.ts
    ├── login-flow.spec.ts
    └── password-reset.spec.ts
```

**Structure Decision**: Web application structure (Option 2) adapted for Next.js 15 App Router with React Server Components. The application uses the App Router's file-based routing with route groups for authenticated vs unauthenticated layouts. Server Components are the default for data fetching, with Client Components used only for interactive auth forms. Supabase client utilities are split by execution context (browser, server, middleware) following the @supabase/ssr pattern for optimal SSR support.

## Complexity Tracking

> No constitution violations requiring justification. The implementation follows all constitutional principles with documented rationale for any partial compliance (Circuit breaker omitted for auth with justification provided in Constitution Check section).
